# .github/workflows/agents.yml
# Agent Task Orchestration
# Validates agent-created PRs meet quality gates before review.

name: Agent Quality Gates

on:
  pull_request:
    branches: [develop, main]
    # Only run on agent-created branches
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/ISSUE_TEMPLATE/**'

jobs:
  detect-agent-pr:
    runs-on: ubuntu-latest
    outputs:
      is_agent: ${{ steps.check.outputs.is_agent }}
    steps:
      - name: Check if agent branch
        id: check
        run: |
          if [[ "${{ github.head_ref }}" == agent/* ]]; then
            echo "is_agent=true" >> $GITHUB_OUTPUT
          else
            echo "is_agent=false" >> $GITHUB_OUTPUT
          fi

  validate-pr-size:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}..HEAD | tail -1 | awk '{print $4+$6}')
          echo "Lines changed: $LINES_CHANGED"
          if [ "$LINES_CHANGED" -gt 400 ]; then
            echo "::warning::PR exceeds 400 lines changed ($LINES_CHANGED). Consider splitting."
          fi

  validate-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check conventional commits
        run: |
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s")
          PATTERN="^(feat|fix|refactor|test|chore|docs|style|perf|ci|build|revert)(\(.+\))?: .+"
          FAILED=0
          while IFS= read -r commit; do
            if [[ ! "$commit" =~ $PATTERN ]]; then
              echo "::error::Non-conventional commit: $commit"
              FAILED=1
            fi
          done <<< "$COMMITS"
          if [ "$FAILED" -eq 1 ]; then
            echo "::error::All commits must follow conventional commit format"
            exit 1
          fi

      - name: Check for AI co-author tags
        run: |
          if git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%b" | grep -qi "co-authored-by.*claude"; then
            echo "::error::Found 'Co-Authored-By: Claude' in commit messages. This is not allowed."
            exit 1
          fi

  validate-migrations:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'alembic/')
    steps:
      - uses: actions/checkout@v4

      - name: Check migration integrity
        run: |
          # Ensure no existing migrations were modified
          MODIFIED=$(git diff --name-only origin/${{ github.base_ref }}..HEAD -- 'apps/api/alembic/versions/*.py' | head -20)
          for file in $MODIFIED; do
            if git show origin/${{ github.base_ref }}:"$file" &>/dev/null 2>&1; then
              echo "::error::Existing migration modified: $file. Never edit existing migrations."
              exit 1
            fi
          done

  require-human-review:
    runs-on: ubuntu-latest
    needs: detect-agent-pr
    if: needs.detect-agent-pr.outputs.is_agent == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for protected file changes
        run: |
          PROTECTED_PATHS="apps/api/app/models/ alembic/ docker/ .github/workflows/ .claude/"
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}..HEAD)

          for path in $PROTECTED_PATHS; do
            if echo "$CHANGED" | grep -q "^$path"; then
              echo "::warning::Agent PR modifies protected path: $path â€” requires human review (CODEOWNERS enforced)"
            fi
          done
